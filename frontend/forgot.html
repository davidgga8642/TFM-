<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>He olvidado mi contraseÃ±a</title>
    <link rel="stylesheet" href="css/styles.css" />
  </head>
  <body>
    <nav class="nav"><a href="index.html">TFM Empresas</a></nav>
    <main class="hero">
      <div class="card" style="width:min(92vw,480px)">
        <h1 class="title">Â¿Has olvidado tu contraseÃ±a?</h1>
        <p class="subtitle">Introduce tu correo y te enviaremos un enlace para restablecerla.</p>
        <div class="vertical" style="margin-top:12px">
          <label>Email</label>
          <input id="email" class="input" placeholder="tucorreo@empresa.com" />
          <button id="sendBtn" class="btn primary">Enviar enlace</button>
          <p id="msg" class="small"></p>
        </div>
      </div>
    </main>
    <script type="module">
      async function api(path, opts={}){
        const res = await fetch(path, { credentials:'include', headers:{ 'Content-Type':'application/json' }, ...opts })
        const data = await res.json().catch(()=>null)
        if(!res.ok) throw new Error(data?.error || 'Error')
        return data
      }
      document.getElementById('sendBtn').addEventListener('click', async ()=>{
        const email = document.getElementById('email').value.trim()
        if(!email) return alert('Introduce tu email')
        try{
          const r = await api('api/auth/forgot', { method:'POST', body: JSON.stringify({ email }) })
          let msg = 'âœ… Email enviado correctamente.'
          if(r.preview_url && r.ethereal_user){
            // Es Ethereal (desarrollo)
            msg += '<br/><br/><strong style="color:#17a2b8;">ğŸ“§ Credenciales Ethereal:</strong><br/>'
            msg += 'Email: <code style="background:#f8f9fa; padding:2px 6px; border-radius:3px;">' + r.ethereal_user + '</code><br/>'
            msg += 'ContraseÃ±a: <code style="background:#f8f9fa; padding:2px 6px; border-radius:3px;">' + r.ethereal_pass + '</code><br/><br/>'
            msg += '<a href="https://ethereal.email/login" target="_blank" style="color:#17a2b8; text-decoration:none; font-weight:bold;">ğŸ‘‰ Abre tu bandeja en Ethereal aquÃ­</a><br/>'
            msg += '<a href="' + r.preview_url + '" target="_blank" style="color:blue; text-decoration:underline; display:inline-block; margin-top:8px;">Ver este email directamente</a>'
          } else {
            msg += ' Revisa tu bandeja de entrada.'
          }
          document.getElementById('msg').innerHTML = msg
          document.getElementById('msg').style.color = 'green'
        }catch(e){ 
          if(e.message.includes('No existe usuario')) {
            alert('âŒ No existe usuario con ese email')
          } else {
            alert('Error: ' + e.message)
          }
          document.getElementById('msg').textContent = ''
        }
      })
    </script>
  </body>
</html>
